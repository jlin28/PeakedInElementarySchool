<!DOCTYPE html>

<!--
Joyce Lin, Evan Khosh, Sean Zheng, Zixi Qiao
PIES
SoftDev
P01 -- ArRESTed Development
TBD
-->

<html>

<head>
  <title> CHRIVIA </title>

  <!-- CUSTOM CSS -->
  <link rel="stylesheet"
    type="text/css"
    href="/static/css/style.css">

  <!-- BOOTSTRAP CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
    crossorigin="anonymous">

  <!-- PAGE SPECIFIC CSS -->
  <style>
    /* BOARD IMAGE */
    .board {
      position: absolute;
      z-index: 0;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);

      width:clamp(200px, 1000px,1000px);
      height:auto;
    }

    #images, .row { /* TESTING PURPOSES */
      border-style: solid;
      border-width: thin;
      border-color: red;
    }

    /* GRID STYLING */
    #images, #buttons {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50.5%);
      border-color: blue; /* TESTING PURPOSES */

      width: clamp(100px, 505px,505px);
      height: clamp(100px, 500px,500px);
    }

    .row {
      height: 12.52%;
    }

    .col {
      width: clamp(10px, 50px,50px);
    }

    /* Z INDEXES */
    #images {
      z-index: 1;
    }

    #buttons {
      z-index: 2;
    }

    /* IMAGES GRID */
    .piece {
      width: 100px;
      height: auto;
      overflow: hidden;

      margin-left: -27px;
      margin-top: -25px;
    }

    /* BUTTONS GRID */
    button {
      position: absolute;
      z-index: 2;
      margin-left: -12px;
      background: none;
      border-style: none;

      width: clamp(10px, 61px,61px);
      height: 12.52%;
    }
  </style>
</head>

<body style="background-color:#D1C0A8">
  <!-- BOARD -->
  <div class="container">
    <!-- IMAGE -->
    <image src="/static/images/board.png" class="board">

    <!-- IMAGE GRID -->
    <div id="images" class="container">
      {% set pieces = ['rook', 'knight', 'bishop', 'queen', 'king','pawn'] %}
      {% set gridlabel = ['a','b','c','d','e','f','g','h'] %}
      {% for ROW in board %}
        <div class="row">
          {% set index = loop.index %}
          {% for COL in ROW %}
            <div class="col image {{ gridlabel[loop.index0] }}{{ index }}">
              {% if COL < 0 %}
                <img class="center black piece {{ pieces[COL|abs - 1] }}"
                      src="/static/sprites/black/{{ pieces[COL|abs - 1] }}/idle.png"
                      alt="{{ pieces[COL|abs - 1] }}">
              {% elif COL > 0 %}
                <img class="center white piece {{ pieces[COL|abs - 1] }}"
                      src="/static/sprites/white/{{ pieces[COL - 1] }}/idle.png"
                      alt="{{ pieces[COL - 1]}}">
              <!-- TESTING PURPOSES -->
              {% else %}
                {{ gridlabel[loop.index0] }}{{ index }}
              <!-- -->
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    <!-- BUTTON GRID -->
    <div id="buttons" class="container">
      {% for ROW in board %}
        <div class="row">
          {% set index = loop.index %}
          {% for COL in ROW %}
            <div class="col {{ gridlabel[loop.index0] }}{{ index }}">
              <button onclick="select(this.parentElement.className.split(' ')[1])"> </button>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"> </script>

  <!-- PAGE-SPECIFIC JS -->
  <script>
    var selected = null;
    var validMoves = null;
    var moving = false;

    var stopMove = function(delay, animation) {
      setTimeout(function() {
          animation.pause()

          let sprite = document.querySelector("." + selected.className.split(" ")[1] + " img");
          let classnames = sprite.className.split(" ");
          sprite.src = '/static/sprites/' + classnames[1] + '/' + classnames[3] + '/idle.png';
        }, delay - 50
      );

      setTimeout(function() {
          window.location.replace(window.location.href)
        }, delay + 1000
      );
    }

    var select = function(position) {
      let xhttp = new XMLHttpRequest();

      if (selected != null) {
        if (validMoves.includes(position)) {
          moving = true;

          let board = document.getElementById('buttons');
          let square = document.getElementsByClassName(position)[1];
          let sprite = document.querySelector("." + selected.className.split(" ")[1] + " img");
          let classnames = sprite.className.split(" ");

          let currentPos = selected.getBoundingClientRect();
          let newPos = square.getBoundingClientRect();

          let areaOfBoard = board.offsetWidth * board.offsetHeight;
          let translationX = newPos.left - currentPos.left;
          let translationY = newPos.bottom - currentPos.bottom;
          let distance = Math.sqrt(Math.pow(translationX,2) + Math.pow(translationY,2))

          sprite.src = '/static/sprites/' + classnames[1] + '/' + classnames[3] + '/walk.gif';
          let anim = sprite.animate(
            [{transform: 'translate(0, 0)'}, {transform: 'translate(' + translationX + 'px, ' + translationY + 'px)'}],
            {
             duration: 1100 * (1 - distance/areaOfBoard),
             iterations: 1,
             easing: 'linear',
           },
          );

          anim.play()

          if (document.querySelector("." + square.className.split(" ")[1] + " img") != null) {
            setTimeout(function() {
              takePiece(document.querySelector("." + square.className.split(" ")[1] + " img"))
            },
              1100 * (1 - distance/areaOfBoard));
          };

          stopMove(1100 * (1 - distance/areaOfBoard), anim);
        } else if (!moving) {
          let prev = document.querySelector("." + selected.className.split(" ")[1] + " img");
          let classnames = prev.className.split(" ");

          prev.src = '/static/sprites/' + classnames[1] + '/' + classnames[3] + '/idle.png';
        }
      }
      if (!moving) {
        xhttp.open('POST', window.location.href, true);
        xhttp.setRequestHeader("select", position);
        xhttp.send();

        // checks if xhttp request is done and there were no errors (200 -- ok request) !!
    //    xhttp.onreadystatechange = function() {
      //    if (this.readyState == 4 && this.status == 200) {
        //    validMoves =
        //  }
      //  }

        let piece = document.getElementsByClassName(position)[1];
        selected = piece;
        let sprite = document.querySelector("." + piece.className.split(" ")[1] + " img");

        if (sprite != null) {
          let classnames = sprite.className.split(" ");
          sprite.src = '/static/sprites/' + classnames[1] + '/' + classnames[3] + '/select.gif';
          validMoves = ['a1', 'a2'] // temporary placeholder --> change with actual valid moves
        } else {
          validMoves = null;
        }
      }
    }

    var takePiece = function(piece) {
      let multiplier = [1,-1];
      let randCoordx = (Math.floor(Math.random() * 2000) + 1000) * multiplier[Math.floor(Math.random()*2)];
      let randCoordy = (Math.floor(Math.random() * 2000) + 1000) * multiplier[Math.floor(Math.random()*2)];
      console.log(randCoordx + "," + randCoordy);
      piece.animate(
        [{transform: 'translate(0, 0)'},
          {transform: 'translate(' + randCoordx + 'px, ' + randCoordy + 'px)'}],
        {
         duration: 2000,
         iterations: 1,
         easing: 'linear',
         composite: 'add',
       },
      );

      piece.animate(
        [{transform: 'rotate(0)'}, {transform: 'rotate(360deg)'}],
        {
         duration: 250,
         iterations: 100,
         easing: 'linear',
         composite: 'add',
       },
      );
    }

  </script>
</body>

</html>
